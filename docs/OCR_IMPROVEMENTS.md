# 车牌识别优化说明

## 问题描述

之前的版本在识别车牌时，只能识别到车牌颜色（如"蓝"），无法识别完整的车牌号码（如"鲁P233CV"），导致车牌信息不完整。

---

## 优化方案

### 1. 改进AI提示词

**优化前：**
```
1. 车牌号（例如：蓝 鲁P233CV）
```

**优化后：**
```
1. 车牌号：必须包含车牌颜色和完整号码（例如：蓝 鲁P233CV，黄 京A12345）
   - 车牌颜色：蓝/黄/绿/白/黑
   - 车牌号码：完整的省份简称+字母+数字组合

请严格按照以下格式输出，每个字段单独一行：
车牌号：[颜色] [完整车牌号]

注意：车牌号必须完整，包含颜色和号码，中间用空格分隔。
```

**改进点：**
- 明确要求AI必须识别车牌颜色和完整号码
- 详细说明车牌号的组成部分
- 强调输出格式要求
- 增加示例说明

---

### 2. 优化正则表达式匹配

**优化前：**
```typescript
const plateMatch = content.match(/车牌[号]?[:：]?\s*([^\n，,。\s]+)/i)
```

**问题：**
- 匹配规则过于简单，容易只匹配到第一个词（颜色）
- 遇到空格就停止匹配

**优化后：**
```typescript
// 主匹配：匹配"车牌号："后的完整内容，直到遇到下一个字段
const plateMatch = content.match(/车牌[号]?[:：]?\s*([蓝黄绿白黑][\s]?[^\n，,。]+?)(?=\n|车型|轴|吨|入口|时间|金额|$)/i)

// 备用匹配：直接查找颜色+车牌号模式
const altPlateMatch = content.match(/([蓝黄绿白黑][\s]?[A-Z京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-Z0-9]{5,6})/i)
```

**改进点：**
- 使用前瞻断言，匹配到下一个字段之前的所有内容
- 明确匹配车牌颜色（蓝/黄/绿/白/黑）
- 支持颜色和号码之间有空格或无空格
- 增加备用匹配规则，提高识别成功率
- 支持所有省份简称

---

### 3. 优化用户界面提示

**结果页面：**
- 标签从"车牌号"改为"车牌号（含颜色）"
- placeholder从"请输入车牌号"改为"如：蓝 鲁P233CV"

**改进点：**
- 明确告知用户车牌号应包含颜色
- 提供具体示例，便于用户理解

---

## 识别效果

### 支持的车牌格式

| 格式 | 示例 | 说明 |
|------|------|------|
| 颜色+空格+号码 | 蓝 鲁P233CV | 标准格式 |
| 颜色+号码（无空格） | 蓝鲁P233CV | 紧凑格式 |
| 黄牌 | 黄 京A12345 | 大型车辆 |
| 绿牌 | 绿 沪D88888 | 新能源车 |

### 支持的车牌颜色

- 🔵 蓝色：小型车辆
- 🟡 黄色：大型车辆、货车
- 🟢 绿色：新能源车辆
- ⚪ 白色：特种车辆
- ⚫ 黑色：外籍车辆

### 支持的省份简称

京、津、沪、渝、冀、豫、云、辽、黑、湘、皖、鲁、新、苏、浙、赣、鄂、桂、甘、晋、蒙、陕、吉、闽、贵、粤、青、藏、川、宁、琼、使、领

---

## 测试建议

### 测试用例

1. **标准蓝牌**
   - 输入：包含"蓝 鲁P233CV"的票据图片
   - 期望：识别出"蓝 鲁P233CV"

2. **黄牌货车**
   - 输入：包含"黄 京A12345"的票据图片
   - 期望：识别出"黄 京A12345"

3. **绿牌新能源**
   - 输入：包含"绿 沪D88888"的票据图片
   - 期望：识别出"绿 沪D88888"

4. **无空格格式**
   - 输入：包含"蓝鲁P233CV"的票据图片
   - 期望：识别出"蓝鲁P233CV"或"蓝 鲁P233CV"

### 测试步骤

1. 打开智票通小程序
2. 进入"识别"页面
3. 选择或拍摄包含车牌信息的票据图片
4. 点击"开始识别"
5. 等待识别完成
6. 检查识别结果中的"车牌号"字段
7. 验证是否包含颜色和完整号码

### 验证要点

- ✅ 车牌颜色正确识别
- ✅ 车牌号码完整识别
- ✅ 颜色和号码之间有空格分隔
- ✅ 可以手动编辑修正
- ✅ 保存后在历史记录中正确显示

---

## 注意事项

1. **图片质量要求**
   - 确保票据图片清晰
   - 车牌号文字可辨认
   - 光线充足，避免反光

2. **识别准确率**
   - AI识别准确率受图片质量影响
   - 如识别有误，可手动修正
   - 建议使用原始票据图片，避免截图

3. **手动修正**
   - 识别结果支持手动编辑
   - 修正后的数据会保存到数据库
   - 确保车牌号格式为"颜色 号码"

---

## 技术细节

### 正则表达式说明

```typescript
// 主匹配规则
/车牌[号]?[:：]?\s*([蓝黄绿白黑][\s]?[^\n，,。]+?)(?=\n|车型|轴|吨|入口|时间|金额|$)/i

// 分解说明：
// 车牌[号]?       - 匹配"车牌"或"车牌号"
// [:：]?          - 可选的冒号（中英文）
// \s*             - 可选的空白字符
// [蓝黄绿白黑]     - 车牌颜色
// [\s]?           - 可选的空格
// [^\n，,。]+?    - 匹配除换行和标点外的字符（非贪婪）
// (?=...)         - 前瞻断言，匹配到下一个字段之前
```

### 备用匹配规则

```typescript
// 直接匹配颜色+车牌号模式
/([蓝黄绿白黑][\s]?[A-Z京津沪渝...][A-Z0-9]{5,6})/i

// 分解说明：
// [蓝黄绿白黑]     - 车牌颜色
// [\s]?           - 可选的空格
// [A-Z京津沪...]  - 省份简称（字母或汉字）
// [A-Z0-9]{5,6}   - 5-6位字母数字组合
```

---

## 更新日志

### v1.0.1 (2025-12-10)
- 🔧 优化车牌识别逻辑
- 🔧 改进AI提示词
- 🔧 增强正则表达式匹配
- 🔧 优化用户界面提示
- ✅ 支持完整车牌号识别（颜色+号码）

---

© 2025 智票通 - 专业的车辆通行费票据识别工具
